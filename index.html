<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floresta das 99 Noites - Jurerê</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { MapPin, Trophy, Backpack, Target, Plus, Play, Award, Heart, Sword, Shield, ChevronRight, Save, RotateCcw, Navigation } = (() => {
            const createIcon = (d) => ({ className = "", size = 24 }) => 
                React.createElement('svg', { 
                    width: size, 
                    height: size, 
                    fill: 'none', 
                    stroke: 'currentColor', 
                    strokeWidth: 2, 
                    strokeLinecap: 'round', 
                    strokeLinejoin: 'round',
                    className 
                }, React.createElement('path', { d }));
            
            return {
                MapPin: createIcon('M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'),
                Trophy: createIcon('M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22 M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22 M18 2H6v7a6 6 0 0 0 12 0V2z'),
                Backpack: createIcon('M17 5H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z M8 2v3 M16 2v3 M8 12h8 M8 16h8'),
                Target: createIcon('M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z'),
                Plus: createIcon('M12 5v14 M5 12h14'),
                Play: createIcon('M5 3l14 9-14 9V3z'),
                Award: createIcon('M12 15a7 7 0 1 0 0-14 7 7 0 0 0 0 14z M8.21 13.89L7 23l5-3 5 3-1.21-9.12'),
                Heart: createIcon('M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z'),
                Sword: createIcon('M14.5 17.5L3 6V3h3l11.5 11.5 M13 19l6-6 M16 16l5 5 M19 21l2-2'),
                Shield: createIcon('M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'),
                ChevronRight: createIcon('M9 18l6-6-6-6'),
                Save: createIcon('M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8'),
                RotateCcw: createIcon('M1 4v6h6 M3.51 15a9 9 0 1 0 2.13-9.36L1 10'),
                Navigation: createIcon('M3 11l19-9-9 19-2-8-8-2z')
            };
        })();

        const CAPTURE_RADIUS = 40; // 40 metros (ajustável)
        
        const App = () => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const locationMarkersRef = useRef([]);

            // Carregar estado do localStorage
            const loadState = () => {
                const saved = localStorage.getItem('forest99nights');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            };

            const savedState = loadState();

            const [screen, setScreen] = useState(savedState?.screen || 'splash');
            const [points, setPoints] = useState(savedState?.points || 0);
            const [playerHealth, setPlayerHealth] = useState(savedState?.playerHealth || 100);
            const [inventory, setInventory] = useState(savedState?.inventory || []);
            const [discoveredLocations, setDiscoveredLocations] = useState(savedState?.discoveredLocations || []);
            const [currentLocation, setCurrentLocation] = useState(null);
            const [userPosition, setUserPosition] = useState(null);
            const [gameMode, setGameMode] = useState(savedState?.gameMode || null);
            const [locations, setLocations] = useState(savedState?.locations || []);
            const [inBattle, setInBattle] = useState(false);
            const [enemy, setEnemy] = useState(null);
            const [missions, setMissions] = useState(savedState?.missions || [
                { id: 1, name: 'Encontre 3 Cultistas', progress: 0, target: 3, reward: 15, completed: false },
                { id: 2, name: 'Colete 5 Itens', progress: 0, target: 5, reward: 10, completed: false },
                { id: 3, name: 'Derrote o Alpha Wolf', progress: 0, target: 1, reward: 30, completed: false }
            ]);

            // Salvar estado no localStorage
            useEffect(() => {
                const state = {
                    screen,
                    points,
                    playerHealth,
                    inventory,
                    discoveredLocations,
                    gameMode,
                    locations,
                    missions
                };
                localStorage.setItem('forest99nights', JSON.stringify(state));
            }, [screen, points, playerHealth, inventory, discoveredLocations, gameMode, locations, missions]);

            const creatures = [
                { id: 'deer', name: 'O Cervo (Wendigo)', type: 'legendary', points: 30, rarity: 'Lendário', isEnemy: true, health: 100, damage: 25, icon: '🦌' },
                { id: 'owl', name: 'A Coruja', type: 'legendary', points: 30, rarity: 'Lendário', isEnemy: true, health: 80, damage: 20, icon: '🦉' },
                { id: 'ram', name: 'O Carneiro', type: 'legendary', points: 30, rarity: 'Lendário', isEnemy: true, health: 90, damage: 22, icon: '🐏' },
                { id: 'alpha_wolf', name: 'Alpha Wolf', type: 'epic', points: 20, rarity: 'Épico', isEnemy: true, health: 60, damage: 18, icon: '🐺' },
                { id: 'cultist_king', name: 'Cultist King', type: 'epic', points: 20, rarity: 'Épico', isEnemy: true, health: 70, damage: 20, icon: '👑' },
                { id: 'bear', name: 'Urso', type: 'epic', points: 20, rarity: 'Épico', isEnemy: true, health: 80, damage: 25, icon: '🐻' },
                { id: 'flashlight', name: 'Lanterna', type: 'epic', points: 20, rarity: 'Épico', isEnemy: false, icon: '🔦' },
                { id: 'katana', name: 'Katana', type: 'epic', points: 20, rarity: 'Épico', isEnemy: false, icon: '⚔️' },
                { id: 'wolf', name: 'Lobo', type: 'rare', points: 10, rarity: 'Raro', isEnemy: true, health: 40, damage: 12, icon: '🐺' },
                { id: 'cultist', name: 'Cultista', type: 'rare', points: 10, rarity: 'Raro', isEnemy: true, health: 30, damage: 10, icon: '🧙' },
                { id: 'crossbow_cultist', name: 'Cultista Arqueiro', type: 'rare', points: 10, rarity: 'Raro', isEnemy: true, health: 25, damage: 15, icon: '🏹' },
                { id: 'fox', name: 'Raposa Ártica', type: 'rare', points: 10, rarity: 'Raro', isEnemy: false, icon: '🦊' },
                { id: 'torch', name: 'Tocha', type: 'rare', points: 10, rarity: 'Raro', isEnemy: false, icon: '🔥' },
                { id: 'armor', name: 'Armadura', type: 'rare', points: 10, rarity: 'Raro', isEnemy: false, icon: '🛡️' },
                { id: 'rabbit', name: 'Coelho', type: 'common', points: 5, rarity: 'Comum', isEnemy: false, icon: '🐰' },
                { id: 'wood', name: 'Madeira', type: 'common', points: 5, rarity: 'Comum', isEnemy: false, icon: '🪵' },
                { id: 'mushroom', name: 'Cogumelo', type: 'common', points: 5, rarity: 'Comum', isEnemy: false, icon: '🍄' },
                { id: 'crystal', name: 'Cristal', type: 'common', points: 5, rarity: 'Comum', isEnemy: false, icon: '💎' },
                { id: 'branch', name: 'Galho Mágico', type: 'common', points: 5, rarity: 'Comum', isEnemy: false, icon: '🌿' }
            ];

            // Pontos turísticos expandidos de Jurerê
            const jurereLocations = [
                { lat: -27.4521, lng: -48.4947, name: 'Praia de Jurerê Internacional', creature: 'deer' },
                { lat: -27.4535, lng: -48.4962, name: 'Jurerê Open Shopping', creature: 'cultist_king' },
                { lat: -27.4510, lng: -48.4930, name: 'Praça da Praia', creature: 'alpha_wolf' },
                { lat: -27.4528, lng: -48.4955, name: 'Avenida dos Búzios', creature: 'owl' },
                { lat: -27.4515, lng: -48.4940, name: 'Calçadão', creature: 'wolf' },
                { lat: -27.4540, lng: -48.4970, name: 'Parque Jurerê', creature: 'bear' },
                { lat: -27.4505, lng: -48.4925, name: 'Píer de Jurerê', creature: 'cultist' },
                { lat: -27.4525, lng: -48.4950, name: 'Mirante da Praia', creature: 'flashlight' },
                { lat: -27.4518, lng: -48.4945, name: 'Quiosque Central', creature: 'torch' },
                { lat: -27.4512, lng: -48.4935, name: 'Bosque das Cerejeiras', creature: 'rabbit' },
                { lat: -27.4532, lng: -48.4958, name: 'Marina de Jurerê', creature: 'fox' },
                { lat: -27.4508, lng: -48.4933, name: 'Área de Esportes', creature: 'wood' },
                { lat: -27.4522, lng: -48.4952, name: 'Restaurante Beira-Mar', creature: 'mushroom' },
                { lat: -27.4538, lng: -48.4968, name: 'Condomínio IL Campanario', creature: 'crystal' },
                { lat: -27.4516, lng: -48.4942, name: 'Posto de Salva-Vidas', creature: 'branch' },
                { lat: -27.4530, lng: -48.4960, name: 'Beach Club', creature: 'crossbow_cultist' },
                { lat: -27.4513, lng: -48.4938, name: 'Quadra de Vôlei', creature: 'armor' },
                { lat: -27.4527, lng: -48.4954, name: 'Ciclovia Beira-Mar', creature: 'katana' },
                { lat: -27.4520, lng: -48.4948, name: 'Parque Infantil', creature: 'ram' }
            ];

            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const newPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            setUserPosition(newPos);
                            
                            // Atualizar marcador do usuário no mapa
                            if (mapInstanceRef.current && userMarkerRef.current) {
                                userMarkerRef.current.setLatLng([newPos.lat, newPos.lng]);
                                mapInstanceRef.current.setView([newPos.lat, newPos.lng], mapInstanceRef.current.getZoom());
                            }
                        },
                        (error) => console.log('GPS Error:', error),
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                    );
                }
            }, []);

            const calculateDistance = (lat1, lng1, lat2, lng2) => {
                const R = 6371e3;
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lng2 - lng1) * Math.PI / 180;

                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c;
            };

            useEffect(() => {
                if (userPosition && locations.length > 0) {
                    locations.forEach(loc => {
                        if (!discoveredLocations.includes(loc.id)) {
                            const distance = calculateDistance(
                                userPosition.lat, userPosition.lng,
                                loc.lat, loc.lng
                            );
                            
                            if (distance <= CAPTURE_RADIUS) {
                                handleDiscoverLocation(loc);
                            }
                        }
                    });
                }
            }, [userPosition, locations]);

            // Inicializar mapa quando entrar na tela do mapa
            useEffect(() => {
                if (screen === 'map' && mapRef.current && !mapInstanceRef.current) {
                    const initialPos = userPosition || { lat: -27.4521, lng: -48.4947 };
                    
                    const map = L.map(mapRef.current).setView([initialPos.lat, initialPos.lng], 16);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    // Marcador do usuário
                    if (userPosition) {
                        const userIcon = L.divIcon({
                            className: 'user-marker',
                            html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59,130,246,0.5);"></div>',
                            iconSize: [20, 20]
                        });
                        userMarkerRef.current = L.marker([userPosition.lat, userPosition.lng], { icon: userIcon }).addTo(map);
                    }

                    mapInstanceRef.current = map;
                }

                // Adicionar marcadores dos locais
                if (screen === 'map' && mapInstanceRef.current && locations.length > 0) {
                    // Limpar marcadores anteriores
                    locationMarkersRef.current.forEach(marker => marker.remove());
                    locationMarkersRef.current = [];

                    locations.forEach(loc => {
                        const creature = creatures.find(c => c.id === loc.creature);
                        const discovered = discoveredLocations.includes(loc.id);
                        
                        const color = discovered ? '#10b981' : 
                                     creature.type === 'legendary' ? '#a855f7' :
                                     creature.type === 'epic' ? '#eab308' :
                                     creature.type === 'rare' ? '#3b82f6' : '#6b7280';

                        const markerIcon = L.divIcon({
                            className: 'location-marker',
                            html: `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${creature.icon}</div>`,
                            iconSize: [30, 30]
                        });

                        const marker = L.marker([loc.lat, loc.lng], { icon: markerIcon })
                            .bindPopup(`<b>${loc.name}</b><br>${creature.name}<br>${creature.rarity}`)
                            .addTo(mapInstanceRef.current);
                        
                        locationMarkersRef.current.push(marker);
                    });
                }
            }, [screen, locations, userPosition, discoveredLocations]);

            const handleDiscoverLocation = (location) => {
                const creature = creatures.find(c => c.id === location.creature);
                setCurrentLocation({ ...location, creature });
                setDiscoveredLocations([...discoveredLocations, location.id]);
                
                if (creature.isEnemy) {
                    setEnemy({ ...creature, currentHealth: creature.health });
                    setInBattle(true);
                    setScreen('battle');
                } else {
                    setScreen('discovery');
                }
            };

            const forceCapture = (location) => {
                if (!discoveredLocations.includes(location.id)) {
                    handleDiscoverLocation(location);
                }
            };

            const collectItem = () => {
                const creature = currentLocation.creature;
                setPoints(points + creature.points);
                setInventory([...inventory, creature]);
                updateMissions(creature);
                setScreen('map');
                setCurrentLocation(null);
            };

            const updateMissions = (creature) => {
                const newMissions = missions.map(mission => {
                    if (mission.id === 1 && creature.id.includes('cultist') && !mission.completed) {
                        const newProgress = mission.progress + 1;
                        if (newProgress >= mission.target) {
                            setPoints(p => p + mission.reward);
                            return { ...mission, progress: newProgress, completed: true };
                        }
                        return { ...mission, progress: newProgress };
                    }
                    if (mission.id === 2 && !mission.completed) {
                        const newProgress = mission.progress + 1;
                        if (newProgress >= mission.target) {
                            setPoints(p => p + mission.reward);
                            return { ...mission, progress: newProgress, completed: true };
                        }
                        return { ...mission, progress: newProgress };
                    }
                    return mission;
                });
                setMissions(newMissions);
            };

            const attack = () => {
                const playerDamage = 20;
                const newEnemyHealth = enemy.currentHealth - playerDamage;
                
                if (newEnemyHealth <= 0) {
                    setPoints(points + enemy.points);
                    setInventory([...inventory, enemy]);
                    
                    if (enemy.id === 'alpha_wolf') {
                        const newMissions = missions.map(m => 
                            m.id === 3 ? { ...m, progress: 1, completed: true } : m
                        );
                        setMissions(newMissions);
                        setPoints(p => p + 30);
                    }
                    
                    updateMissions(enemy);
                    setInBattle(false);
                    setEnemy(null);
                    setScreen('map');
                } else {
                    setEnemy({ ...enemy, currentHealth: newEnemyHealth });
                    
                    setTimeout(() => {
                        const newPlayerHealth = playerHealth - enemy.damage;
                        if (newPlayerHealth <= 0) {
                            setPlayerHealth(0);
                            alert('Você foi derrotado! Retornando ao acampamento...');
                            setInBattle(false);
                            setEnemy(null);
                            setPlayerHealth(100);
                            setScreen('map');
                        } else {
                            setPlayerHealth(newPlayerHealth);
                        }
                    }, 500);
                }
            };

            const flee = () => {
                setInBattle(false);
                setEnemy(null);
                setScreen('map');
            };

            const generateLocalPoints = () => {
                if (!userPosition) {
                    alert('Aguardando localização GPS...');
                    return;
                }
                
                const newLocations = [];
                for (let i = 0; i < 15; i++) {
                    const randomCreature = creatures[Math.floor(Math.random() * creatures.length)];
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = 50 + Math.random() * 100; // 50-150 metros (mais próximo!)
                    
                    const lat = userPosition.lat + (distance / 111000) * Math.cos(angle);
                    const lng = userPosition.lng + (distance / (111000 * Math.cos(userPosition.lat * Math.PI / 180))) * Math.sin(angle);
                    
                    newLocations.push({
                        id: `local_${i}`,
                        lat,
                        lng,
                        name: `Ponto ${i + 1}`,
                        creature: randomCreature.id
                    });
                }
                
                setLocations(newLocations);
                setGameMode('local');
                setScreen('map');
            };

            const startJurereMode = () => {
                const locationsWithId = jurereLocations.map((loc, i) => ({ ...loc, id: `jurere_${i}` }));
                setLocations(locationsWithId);
                setGameMode('jurere');
                setScreen('map');
            };

            const resetGame = () => {
                if (confirm('Tem certeza que deseja resetar todo o progresso?')) {
                    localStorage.removeItem('forest99nights');
                    window.location.reload();
                }
            };

            const getRank = () => {
                if (points >= 76) return { name: 'Diamante', icon: '💎', color: 'text-cyan-400' };
                if (points >= 51) return { name: 'Ouro', icon: '🥇', color: 'text-yellow-400' };
                if (points >= 26) return { name: 'Prata', icon: '🥈', color: 'text-gray-300' };
                return { name: 'Bronze', icon: '🥉', color: 'text-orange-400' };
            };

            const rank = getRank();

            if (screen === 'splash') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-gray-900 via-green-900 to-black flex flex-col items-center justify-center p-6">
                        <div className="text-center space-y-6">
                            <div className="text-8xl mb-4">🌲</div>
                            <h1 className="text-4xl font-bold text-white mb-2">Floresta das</h1>
                            <h1 className="text-5xl font-bold text-green-400 mb-4">99 Noites</h1>
                            <p className="text-xl text-gray-300">Jurerê</p>
                            <button
                                onClick={() => setScreen('menu')}
                                className="mt-8 bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg text-xl font-bold transition-all transform hover:scale-105"
                            >
                                INICIAR AVENTURA
                            </button>
                            {savedState && (
                                <p className="text-sm text-green-400 mt-4">✓ Progresso salvo carregado!</p>
                            )}
                        </div>
                    </div>
                );
            }

            if (screen === 'menu') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-gray-900 to-black text-white p-6">
                        <div className="max-w-md mx-auto">
                            <h1 className="text-3xl font-bold text-center mb-8 text-green-400">Menu Principal</h1>
                            
                            <div className="bg-gray-800 rounded-lg p-4 mb-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-gray-400">Pontos</p>
                                        <p className="text-3xl font-bold">{points}/100</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-gray-400">Ranking</p>
                                        <p className={`text-2xl font-bold ${rank.color}`}>{rank.icon} {rank.name}</p>
                                    </div>
                                </div>
                                <div className="w-full bg-gray-700 rounded-full h-3 mt-4">
                                    <div 
                                        className="bg-green-500 h-3 rounded-full transition-all"
                                        style={{ width: `${points}%` }}
                                    />
                                </div>
                            </div>

                            <div className="space-y-4">
                                <button
                                    onClick={() => locations.length > 0 ? setScreen('map') : setScreen('mode')}
                                    className="w-full bg-green-600 hover:bg-green-700 p-4 rounded-lg flex items-center justify-between transition-all"
                                >
                                    <div className="flex items-center gap-3">
                                        <Play className="w-6 h-6" />
                                        <span className="text-xl font-bold">{locations.length > 0 ? 'CONTINUAR' : 'JOGAR'}</span>
                                    </div>
                                    <ChevronRight className="w-6 h-6" />
                                </button>

                                <button
                                    onClick={() => setScreen('inventory')}
                                    className="w-full bg-gray-700 hover:bg-gray-600 p-4 rounded-lg flex items-center justify-between transition-all"
                                >
                                    <div className="flex items
